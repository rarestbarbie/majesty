#!/bin/bash

SPRITE_WIDTH=56
CONFIG_FILE="crop.cfg"

cd Art/Pops/
rm -f Icons/*.png

for file in Sources/*.png; do
    filename=$(basename "$file" .png)

    # --- Read settings from config file ---
    config_line=$(grep "^${filename}," "$CONFIG_FILE" || echo "")

    # Default crop is 0 pixels from each side
    crop_t=0
    crop_r=0
    crop_b=0
    crop_l=0

    if [[ -n "$config_line" ]]; then
        # If a config is found, parse it
        crop_t=$(echo "$config_line" | cut -d',' -f2)
        crop_r=$(echo "$config_line" | cut -d',' -f3)
        crop_b=$(echo "$config_line" | cut -d',' -f4)
        crop_l=$(echo "$config_line" | cut -d',' -f5)
    fi

    echo "Processing $filename with adjustments (T,R,B,L): ${crop_t},${crop_r},${crop_b},${crop_l}"

    # --- Build crop/pad arguments for ImageMagick ---
    op_args=()

    # Top: positive=chop, negative=splice
    if [[ ${crop_t} -gt 0 ]]; then
        op_args+=(-gravity North -chop "0x${crop_t}")
    elif [[ ${crop_t} -lt 0 ]]; then
        padding_t=$(( -crop_t ))
        op_args+=(-gravity North -splice "0x${padding_t}")
    fi

    # Right: positive=chop, negative=splice
    if [[ ${crop_r} -gt 0 ]]; then
        op_args+=(-gravity East -chop "${crop_r}x0")
    elif [[ ${crop_r} -lt 0 ]]; then
        padding_r=$(( -crop_r ))
        op_args+=(-gravity East -splice "${padding_r}x0")
    fi

    # Bottom: positive=chop, negative=splice
    if [[ ${crop_b} -gt 0 ]]; then
        op_args+=(-gravity South -chop "0x${crop_b}")
    elif [[ ${crop_b} -lt 0 ]]; then
        padding_b=$(( -crop_b ))
        op_args+=(-gravity South -splice "0x${padding_b}")
    fi

    # Left: positive=chop, negative=splice
    if [[ ${crop_l} -gt 0 ]]; then
        op_args+=(-gravity West -chop "${crop_l}x0")
    elif [[ ${crop_l} -lt 0 ]]; then
        padding_l=$(( -crop_l ))
        op_args+=(-gravity West -splice "${padding_l}x0")
    fi

    convert "$file" \
        -fuzz 5% \
        -fill none -draw "color 0,0 floodfill" \
        -background none \
        "${op_args[@]}" \
        +repage \
        -morphology Erode Diamond:1 \
        -filter box -resize ${SPRITE_WIDTH} \
        "Icons/${filename}.png"
done

cd ..
cd ..

mkdir -p Public/Icons
node Scripts/spritesheet.js

TIMESTAMP=$(date +%s)
echo "\$spritesheet-url: '/Icons/Pops.png?v=$TIMESTAMP';" > Stylesheets/generated/_sprite-url.scss
echo "Spritesheet and URL variable baked successfully."

#!/bin/bash

BUCKET_PATH="tayloraswift-apps/majesty"
BUILD_FOLDER=".build.vite"

# Step 1: Sync all non-compressible assets (HTML, images, etc.)
# We explicitly exclude the compressed assets because they need special handling.
echo "Uploading non-compressible assets..."
aws s3 sync "$BUILD_FOLDER" "s3://$BUCKET_PATH" --delete --exclude "*.gz" --exclude "*.html"
aws s3 cp "$BUILD_FOLDER/index.html" "s3://$BUCKET_PATH/play" \
    --content-type "text/html"

# Step 2: Upload compressed files with the correct headers
echo "Uploading compressed assets..."

# Find all .gz files and loop through them
while read -r file; do
    # Get the S3 destination path by removing the .gz and the local folder path
    path_with_extension=$(echo "$file" | sed "s|^$BUILD_FOLDER/||; s|\.gz$||")
    path="$path_with_extension"

    # Determine the correct Content-Type based on the original extension
    content_type=""

    if [[ "$path_with_extension" == *.js ]]; then
        content_type="application/javascript"

    elif [[ "$path_with_extension" == *.css ]]; then
        content_type="text/css"

    elif [[ "$path_with_extension" == *.html ]]; then
        content_type="text/html"
        path="${path%.html}"

    elif [[ "$path_with_extension" == *.json ]]; then
        content_type="application/json"

    elif [[ "$path_with_extension" == *.wasm ]]; then
        content_type="application/wasm"

    else
        echo "Skipping unknown file type: $file"
        continue
    fi

    echo "Uploading: $file to $path"
    aws s3 cp "$file" "s3://$BUCKET_PATH/$path" \
        --content-type "$content_type" \
        --content-encoding "gzip" &
done < <(find "$BUILD_FOLDER" -name "*.gz")

# Wait for all background uploads to finish
wait
echo "Deployment complete!"

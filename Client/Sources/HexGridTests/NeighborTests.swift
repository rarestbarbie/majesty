import Testing
import HexGrids

@Suite
public struct NeighborTests {
    /// The neighbor relationship must be symmetrical. If B is a neighbor of A, then A must
    /// be a neighbor of B. This is the most important test in this suite.
    @Test public func Symmetry() {
        for z: Int8 in 3 ..< 10 {
            HexGrid.init(radius: z).reduce(into: ()) {
                let neighbors: [HexCoordinate] = $1.neighbors(size: z)
                for neighbor: HexCoordinate in neighbors {
                    #expect(neighbor.neighbors(size: z).contains($1))
                }
            }
        }
    }

    /// Checks that tiles have the correct number of neighbors depending on their
    /// position on the grid.
    @Test public func NeighborCount() {
        for z: Int8 in 3 ..< 10 {
            HexGrid.init(radius: z).reduce(into: ()) {
                let neighbors: [HexCoordinate] = $1.neighbors(size: z)
                #expect(neighbors.count == Self.expectedNeighbors(for: $1, size: z))
            }
        }
    }

    /// Helper function to determine the expected neighbor count for a given coordinate.
    private static func expectedNeighbors(for coordinate: HexCoordinate, size z: Int8) -> Int {
        switch coordinate {
        case .x:
            return 0
        case .e:
            return 6
        case .n(let q, let r), .s(let q, let r):
            let s: Int8 = -q - r
            let x: (Int8, Int8, Int8) = (q, r, s)
            let max: Int8 = max(abs(x.0), abs(x.1), abs(x.2))
            if  max < z {
                return 6
            } else {
                // max == z, it's an edge tile.
                // An edge tile has an equatorial neighbor if one of its other
                // coordinates has a magnitude of 1. Otherwise it's a seam tile.
                if abs(x.0) == 1 || abs(x.1) == 1 || abs(x.2) == 1 {
                    return 6 // Has an equatorial neighbor
                } else {
                    return 7 // Seam tile
                }
            }
        }
    }

    /// Spot checks for known neighbor lists.
    @Test public func SpotChecks() {
        // North Pole (z=3)
        #expect(
            Set.init(HexCoordinate.n(0, 0).neighbors(size: 3)) ==
            Set.init([.n(1, 0), .n(1, -1), .n(0, -1), .n(-1, 0), .n(-1, 1), .n(0, 1)])
        )

        // An inner tile (z=3)
        #expect(
            Set.init(HexCoordinate.n(1, 0).neighbors(size: 3)) ==
            Set.init([.n(2, 0), .n(2, -1), .n(1, -1), .n(0, 0), .n(0, 1), .n(1, 1)])
        )

        // Equatorial tile E0 (z=3)
        #expect(
            Set.init(HexCoordinate.e(0).neighbors(size: 3)) ==
            Set.init([.n(3, -1), .n(2, 0), .n(2, 1), .s(2, 1), .s(2, 0), .s(3, -1)])
        )
    }

    @Test public func N4() {
        let size: Int8 = 4
        let grid: HexGrid = .init(radius: size)
        let table: [(HexCoordinate, [HexCoordinate])] = grid.reduce(into: []) {
            $0.append(($1, $1.neighbors(size: size)))
        }

        func format(_ x: HexCoordinate) -> String {
            switch x {
            case .x:
                ".x"
            case .e(let φ):
                ".e(\(φ))"
            case .n(let q, let r):
                ".n(\(q), \(r))"
            case .s(let q, let r):
                ".s(\(q), \(r))"
            }
        }

        /*
        for (x, neighbors): (HexCoordinate, [HexCoordinate]) in table {
            print(
                "\(format(x)): [\(neighbors.lazy.map { format($0) }.joined(separator: ", "))]"
            )
        }
        */

        let n4: [HexCoordinate: [HexCoordinate]] = [
            .e(3): [.n(-4, 1), .n(-3, 0), .n(-3, -1), .s(-3, -1), .s(-3, 0), .s(-4, 1)],
            .n(-4, 1): [.n(-4, 2), .n(-3, 1), .n(-3, 0), .e(3), .s(-4, 1), .s(-4, 2)],
            .s(-4, 1): [.s(-4, 2), .s(-3, 1), .s(-3, 0), .e(3), .n(-4, 1), .n(-4, 2)],
            .n(-4, 2): [
                .n(-4, 3),
                .n(-3, 2),
                .n(-3, 1),
                .n(-4, 1),
                .s(-4, 1),
                .s(-4, 2),
                .s(-4, 3)
            ],
            .s(-4, 2): [
                .s(-4, 3),
                .s(-3, 2),
                .s(-3, 1),
                .s(-4, 1),
                .n(-4, 1),
                .n(-4, 2),
                .n(-4, 3)
            ],
            .n(-4, 3): [.s(-4, 2), .s(-4, 3), .e(4), .n(-3, 3), .n(-3, 2), .n(-4, 2)],
            .s(-4, 3): [.n(-4, 2), .n(-4, 3), .e(4), .s(-3, 3), .s(-3, 2), .s(-4, 2)],
            .e(4): [.n(-3, 4), .n(-3, 3), .n(-4, 3), .s(-4, 3), .s(-3, 3), .s(-3, 4)],
            .n(-3, -1): [.s(-2, -2), .s(-3, -1), .e(3), .n(-3, 0), .n(-2, -1), .n(-2, -2)],
            .s(-3, -1): [.n(-2, -2), .n(-3, -1), .e(3), .s(-3, 0), .s(-2, -1), .s(-2, -2)],
            .n(-3, 0): [.n(-4, 1), .n(-3, 1), .n(-2, 0), .n(-2, -1), .n(-3, -1), .e(3)],
            .s(-3, 0): [.s(-4, 1), .s(-3, 1), .s(-2, 0), .s(-2, -1), .s(-3, -1), .e(3)],
            .n(-3, 1): [.n(-2, 1), .n(-2, 0), .n(-3, 0), .n(-4, 1), .n(-4, 2), .n(-3, 2)],
            .s(-3, 1): [.s(-2, 1), .s(-2, 0), .s(-3, 0), .s(-4, 1), .s(-4, 2), .s(-3, 2)],
            .n(-3, 2): [.n(-2, 2), .n(-2, 1), .n(-3, 1), .n(-4, 2), .n(-4, 3), .n(-3, 3)],
            .s(-3, 2): [.s(-2, 2), .s(-2, 1), .s(-3, 1), .s(-4, 2), .s(-4, 3), .s(-3, 3)],
            .n(-3, 3): [.n(-3, 4), .n(-2, 3), .n(-2, 2), .n(-3, 2), .n(-4, 3), .e(4)],
            .s(-3, 3): [.s(-3, 4), .s(-2, 3), .s(-2, 2), .s(-3, 2), .s(-4, 3), .e(4)],
            .n(-3, 4): [.n(-2, 4), .n(-2, 3), .n(-3, 3), .e(4), .s(-3, 4), .s(-2, 4)],
            .s(-3, 4): [.s(-2, 4), .s(-2, 3), .s(-3, 3), .e(4), .n(-3, 4), .n(-2, 4)],
            .n(-2, -2): [
                .n(-3, -1),
                .n(-2, -1),
                .n(-1, -2),
                .n(-1, -3),
                .s(-1, -3),
                .s(-2, -2),
                .s(-3, -1)
            ],
            .s(-2, -2): [
                .s(-3, -1),
                .s(-2, -1),
                .s(-1, -2),
                .s(-1, -3),
                .n(-1, -3),
                .n(-2, -2),
                .n(-3, -1)
            ],
            .n(-2, -1): [.n(-1, -1), .n(-1, -2), .n(-2, -2), .n(-3, -1), .n(-3, 0), .n(-2, 0)],
            .s(-2, -1): [.s(-1, -1), .s(-1, -2), .s(-2, -2), .s(-3, -1), .s(-3, 0), .s(-2, 0)],
            .n(-2, 0): [.n(-1, 0), .n(-1, -1), .n(-2, -1), .n(-3, 0), .n(-3, 1), .n(-2, 1)],
            .s(-2, 0): [.s(-1, 0), .s(-1, -1), .s(-2, -1), .s(-3, 0), .s(-3, 1), .s(-2, 1)],
            .n(-2, 1): [.n(-1, 1), .n(-1, 0), .n(-2, 0), .n(-3, 1), .n(-3, 2), .n(-2, 2)],
            .s(-2, 1): [.s(-1, 1), .s(-1, 0), .s(-2, 0), .s(-3, 1), .s(-3, 2), .s(-2, 2)],
            .n(-2, 2): [.n(-1, 2), .n(-1, 1), .n(-2, 1), .n(-3, 2), .n(-3, 3), .n(-2, 3)],
            .s(-2, 2): [.s(-1, 2), .s(-1, 1), .s(-2, 1), .s(-3, 2), .s(-3, 3), .s(-2, 3)],
            .n(-2, 3): [.n(-1, 3), .n(-1, 2), .n(-2, 2), .n(-3, 3), .n(-3, 4), .n(-2, 4)],
            .s(-2, 3): [.s(-1, 3), .s(-1, 2), .s(-2, 2), .s(-3, 3), .s(-3, 4), .s(-2, 4)],
            .n(-2, 4): [
                .n(-1, 4),
                .n(-1, 3),
                .n(-2, 3),
                .n(-3, 4),
                .s(-3, 4),
                .s(-2, 4),
                .s(-1, 4)
            ],
            .s(-2, 4): [
                .s(-1, 4),
                .s(-1, 3),
                .s(-2, 3),
                .s(-3, 4),
                .n(-3, 4),
                .n(-2, 4),
                .n(-1, 4)
            ],
            .n(-1, -3): [.n(-2, -2), .n(-1, -2), .n(0, -3), .e(2), .s(-1, -3), .s(-2, -2)],
            .s(-1, -3): [.s(-2, -2), .s(-1, -2), .s(0, -3), .e(2), .n(-1, -3), .n(-2, -2)],
            .n(-1, -2): [.n(0, -2), .n(0, -3), .n(-1, -3), .n(-2, -2), .n(-2, -1), .n(-1, -1)],
            .s(-1, -2): [.s(0, -2), .s(0, -3), .s(-1, -3), .s(-2, -2), .s(-2, -1), .s(-1, -1)],
            .n(-1, -1): [.n(0, -1), .n(0, -2), .n(-1, -2), .n(-2, -1), .n(-2, 0), .n(-1, 0)],
            .s(-1, -1): [.s(0, -1), .s(0, -2), .s(-1, -2), .s(-2, -1), .s(-2, 0), .s(-1, 0)],
            .n(-1, 0): [.n(0, 0), .n(0, -1), .n(-1, -1), .n(-2, 0), .n(-2, 1), .n(-1, 1)],
            .s(-1, 0): [.s(0, 0), .s(0, -1), .s(-1, -1), .s(-2, 0), .s(-2, 1), .s(-1, 1)],
            .n(-1, 1): [.n(0, 1), .n(0, 0), .n(-1, 0), .n(-2, 1), .n(-2, 2), .n(-1, 2)],
            .s(-1, 1): [.s(0, 1), .s(0, 0), .s(-1, 0), .s(-2, 1), .s(-2, 2), .s(-1, 2)],
            .n(-1, 2): [.n(0, 2), .n(0, 1), .n(-1, 1), .n(-2, 2), .n(-2, 3), .n(-1, 3)],
            .s(-1, 2): [.s(0, 2), .s(0, 1), .s(-1, 1), .s(-2, 2), .s(-2, 3), .s(-1, 3)],
            .n(-1, 3): [.n(0, 3), .n(0, 2), .n(-1, 2), .n(-2, 3), .n(-2, 4), .n(-1, 4)],
            .s(-1, 3): [.s(0, 3), .s(0, 2), .s(-1, 2), .s(-2, 3), .s(-2, 4), .s(-1, 4)],
            .n(-1, 4): [.s(-2, 4), .s(-1, 4), .e(5), .n(0, 3), .n(-1, 3), .n(-2, 4)],
            .s(-1, 4): [.n(-2, 4), .n(-1, 4), .e(5), .s(0, 3), .s(-1, 3), .s(-2, 4)],
            .e(2): [.n(-1, -3), .n(0, -3), .n(1, -4), .s(1, -4), .s(0, -3), .s(-1, -3)],
            .n(0, -3): [.n(-1, -3), .n(-1, -2), .n(0, -2), .n(1, -3), .n(1, -4), .e(2)],
            .s(0, -3): [.s(-1, -3), .s(-1, -2), .s(0, -2), .s(1, -3), .s(1, -4), .e(2)],
            .n(0, -2): [.n(1, -2), .n(1, -3), .n(0, -3), .n(-1, -2), .n(-1, -1), .n(0, -1)],
            .s(0, -2): [.s(1, -2), .s(1, -3), .s(0, -3), .s(-1, -2), .s(-1, -1), .s(0, -1)],
            .n(0, -1): [.n(1, -1), .n(1, -2), .n(0, -2), .n(-1, -1), .n(-1, 0), .n(0, 0)],
            .s(0, -1): [.s(1, -1), .s(1, -2), .s(0, -2), .s(-1, -1), .s(-1, 0), .s(0, 0)],
            .n(0, 0): [.n(1, 0), .n(1, -1), .n(0, -1), .n(-1, 0), .n(-1, 1), .n(0, 1)],
            .s(0, 0): [.s(1, 0), .s(1, -1), .s(0, -1), .s(-1, 0), .s(-1, 1), .s(0, 1)],
            .n(0, 1): [.n(1, 1), .n(1, 0), .n(0, 0), .n(-1, 1), .n(-1, 2), .n(0, 2)],
            .s(0, 1): [.s(1, 1), .s(1, 0), .s(0, 0), .s(-1, 1), .s(-1, 2), .s(0, 2)],
            .n(0, 2): [.n(1, 2), .n(1, 1), .n(0, 1), .n(-1, 2), .n(-1, 3), .n(0, 3)],
            .s(0, 2): [.s(1, 2), .s(1, 1), .s(0, 1), .s(-1, 2), .s(-1, 3), .s(0, 3)],
            .n(0, 3): [.n(1, 3), .n(1, 2), .n(0, 2), .n(-1, 3), .n(-1, 4), .e(5)],
            .s(0, 3): [.s(1, 3), .s(1, 2), .s(0, 2), .s(-1, 3), .s(-1, 4), .e(5)],
            .e(5): [.n(1, 3), .n(0, 3), .n(-1, 4), .s(-1, 4), .s(0, 3), .s(1, 3)],
            .n(1, -4): [.s(2, -4), .s(1, -4), .e(2), .n(0, -3), .n(1, -3), .n(2, -4)],
            .s(1, -4): [.n(2, -4), .n(1, -4), .e(2), .s(0, -3), .s(1, -3), .s(2, -4)],
            .n(1, -3): [.n(2, -3), .n(2, -4), .n(1, -4), .n(0, -3), .n(0, -2), .n(1, -2)],
            .s(1, -3): [.s(2, -3), .s(2, -4), .s(1, -4), .s(0, -3), .s(0, -2), .s(1, -2)],
            .n(1, -2): [.n(2, -2), .n(2, -3), .n(1, -3), .n(0, -2), .n(0, -1), .n(1, -1)],
            .s(1, -2): [.s(2, -2), .s(2, -3), .s(1, -3), .s(0, -2), .s(0, -1), .s(1, -1)],
            .n(1, -1): [.n(2, -1), .n(2, -2), .n(1, -2), .n(0, -1), .n(0, 0), .n(1, 0)],
            .s(1, -1): [.s(2, -1), .s(2, -2), .s(1, -2), .s(0, -1), .s(0, 0), .s(1, 0)],
            .n(1, 0): [.n(2, 0), .n(2, -1), .n(1, -1), .n(0, 0), .n(0, 1), .n(1, 1)],
            .s(1, 0): [.s(2, 0), .s(2, -1), .s(1, -1), .s(0, 0), .s(0, 1), .s(1, 1)],
            .n(1, 1): [.n(2, 1), .n(2, 0), .n(1, 0), .n(0, 1), .n(0, 2), .n(1, 2)],
            .s(1, 1): [.s(2, 1), .s(2, 0), .s(1, 0), .s(0, 1), .s(0, 2), .s(1, 2)],
            .n(1, 2): [.n(2, 2), .n(2, 1), .n(1, 1), .n(0, 2), .n(0, 3), .n(1, 3)],
            .s(1, 2): [.s(2, 2), .s(2, 1), .s(1, 1), .s(0, 2), .s(0, 3), .s(1, 3)],
            .n(1, 3): [.n(2, 2), .n(1, 2), .n(0, 3), .e(5), .s(1, 3), .s(2, 2)],
            .s(1, 3): [.s(2, 2), .s(1, 2), .s(0, 3), .e(5), .n(1, 3), .n(2, 2)],
            .n(2, -4): [
                .n(1, -4),
                .n(1, -3),
                .n(2, -3),
                .n(3, -4),
                .s(3, -4),
                .s(2, -4),
                .s(1, -4)
            ],
            .s(2, -4): [
                .s(1, -4),
                .s(1, -3),
                .s(2, -3),
                .s(3, -4),
                .n(3, -4),
                .n(2, -4),
                .n(1, -4)
            ],
            .n(2, -3): [.n(3, -3), .n(3, -4), .n(2, -4), .n(1, -3), .n(1, -2), .n(2, -2)],
            .s(2, -3): [.s(3, -3), .s(3, -4), .s(2, -4), .s(1, -3), .s(1, -2), .s(2, -2)],
            .n(2, -2): [.n(3, -2), .n(3, -3), .n(2, -3), .n(1, -2), .n(1, -1), .n(2, -1)],
            .s(2, -2): [.s(3, -2), .s(3, -3), .s(2, -3), .s(1, -2), .s(1, -1), .s(2, -1)],
            .n(2, -1): [.n(3, -1), .n(3, -2), .n(2, -2), .n(1, -1), .n(1, 0), .n(2, 0)],
            .s(2, -1): [.s(3, -1), .s(3, -2), .s(2, -2), .s(1, -1), .s(1, 0), .s(2, 0)],
            .n(2, 0): [.n(3, 0), .n(3, -1), .n(2, -1), .n(1, 0), .n(1, 1), .n(2, 1)],
            .s(2, 0): [.s(3, 0), .s(3, -1), .s(2, -1), .s(1, 0), .s(1, 1), .s(2, 1)],
            .n(2, 1): [.n(3, 1), .n(3, 0), .n(2, 0), .n(1, 1), .n(1, 2), .n(2, 2)],
            .s(2, 1): [.s(3, 1), .s(3, 0), .s(2, 0), .s(1, 1), .s(1, 2), .s(2, 2)],
            .n(2, 2): [.n(3, 1), .n(2, 1), .n(1, 2), .n(1, 3), .s(1, 3), .s(2, 2), .s(3, 1)],
            .s(2, 2): [.s(3, 1), .s(2, 1), .s(1, 2), .s(1, 3), .n(1, 3), .n(2, 2), .n(3, 1)],
            .n(3, -4): [.n(2, -4), .n(2, -3), .n(3, -3), .e(1), .s(3, -4), .s(2, -4)],
            .s(3, -4): [.s(2, -4), .s(2, -3), .s(3, -3), .e(1), .n(3, -4), .n(2, -4)],
            .n(3, -3): [.n(3, -4), .n(2, -3), .n(2, -2), .n(3, -2), .n(4, -3), .e(1)],
            .s(3, -3): [.s(3, -4), .s(2, -3), .s(2, -2), .s(3, -2), .s(4, -3), .e(1)],
            .n(3, -2): [.n(4, -2), .n(4, -3), .n(3, -3), .n(2, -2), .n(2, -1), .n(3, -1)],
            .s(3, -2): [.s(4, -2), .s(4, -3), .s(3, -3), .s(2, -2), .s(2, -1), .s(3, -1)],
            .n(3, -1): [.n(4, -1), .n(4, -2), .n(3, -2), .n(2, -1), .n(2, 0), .n(3, 0)],
            .s(3, -1): [.s(4, -1), .s(4, -2), .s(3, -2), .s(2, -1), .s(2, 0), .s(3, 0)],
            .n(3, 0): [.n(4, -1), .n(3, -1), .n(2, 0), .n(2, 1), .n(3, 1), .e(0)],
            .s(3, 0): [.s(4, -1), .s(3, -1), .s(2, 0), .s(2, 1), .s(3, 1), .e(0)],
            .n(3, 1): [.s(2, 2), .s(3, 1), .e(0), .n(3, 0), .n(2, 1), .n(2, 2)],
            .s(3, 1): [.n(2, 2), .n(3, 1), .e(0), .s(3, 0), .s(2, 1), .s(2, 2)],
            .e(1): [.n(3, -4), .n(3, -3), .n(4, -3), .s(4, -3), .s(3, -3), .s(3, -4)],
            .n(4, -3): [.s(4, -2), .s(4, -3), .e(1), .n(3, -3), .n(3, -2), .n(4, -2)],
            .s(4, -3): [.n(4, -2), .n(4, -3), .e(1), .s(3, -3), .s(3, -2), .s(4, -2)],
            .n(4, -2): [
                .n(4, -3),
                .n(3, -2),
                .n(3, -1),
                .n(4, -1),
                .s(4, -1),
                .s(4, -2),
                .s(4, -3)
            ],
            .s(4, -2): [
                .s(4, -3),
                .s(3, -2),
                .s(3, -1),
                .s(4, -1),
                .n(4, -1),
                .n(4, -2),
                .n(4, -3)
            ],
            .n(4, -1): [.n(4, -2), .n(3, -1), .n(3, 0), .e(0), .s(4, -1), .s(4, -2)],
            .s(4, -1): [.s(4, -2), .s(3, -1), .s(3, 0), .e(0), .n(4, -1), .n(4, -2)],
            .e(0): [.n(4, -1), .n(3, 0), .n(3, 1), .s(3, 1), .s(3, 0), .s(4, -1)],
        ]


        // Print the table for visual inspection.
        for (x, neighbors): (HexCoordinate, [HexCoordinate]) in table {
            print(
                "'\(x)': [\(neighbors.lazy.map { "'\($0)'" }.joined(separator: ", "))]"
            )

            #expect(neighbors == n4[x])
        }
    }
}
